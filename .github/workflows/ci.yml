name: FPGA Timer Verification CI

on:
  push:
    branches: [ main, task* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      checks: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup FPGA Tools
        uses: YosysHQ/setup-oss-cad-suite@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python Libs
        run: pip3 install vunit_hdl --break-system-packages

      # Run VUnit and generate XML report
      - name: Run VUnit Tests
        run: python3 run.py -v --xunit-xml test_results.xml

      # Run Formal Verification and continue on error to ensure report generation
      - name: Run Formal Verification
        id: sby_step
        run: sby -f timer.sby
        continue-on-error: true

      # Generate a manual JUnit XML report for SBY so it appears in the table
      - name: Generate SBY XML Report
        if: always()
        run: |
          if [ "${{ steps.sby_step.outcome }}" == "success" ]; then
            FAILURES="0"
            FAILURE_BLOCK=""
          else
            FAILURES="1"
            FAILURE_BLOCK="<failure message=\"Formal verification failed. Check logs.\">Error Trace Found</failure>"
          fi
          
          # Write XML content
          cat <<EOF > sby_results.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <testsuite name="Formal Verification" tests="1" failures="$FAILURES" skipped="0" time="1.0">
            <testcase classname="SBY.Formal" name="Property_Proof_10ms_Target" time="1.0">
              $FAILURE_BLOCK
            </testcase>
          </testsuite>
          EOF

      # Process BOTH VUnit and SBY XML reports into one table
      - name: Publish Combined Test Report
        id: test-report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Verification Results Table
          path: '*.xml' # Matches test_results.xml AND sby_results.xml
          reporter: java-junit

      # Fail the job if SBY failed (since we used continue-on-error above)
      - name: Check SBY Status
        if: steps.sby_step.outcome == 'failure'
        run: exit 1

      - name: Create Full Test Summary
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch URL for the Report Table
          REPORT_URL=$(gh api /repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs --jq '.check_runs[] | select(.name=="Verification Results Table") | .html_url' | head -n 1)
          
          # Fetch URL for the Console Logs
          JOB_URL=$(gh run view ${{ github.run_id }} --json jobs --jq '.jobs[] | select(.name=="test") | .url')
          
          if [ -z "$REPORT_URL" ]; then REPORT_URL="$JOB_URL"; fi

          # VUnit Stats
          VUNIT_PASSED=${{ steps.test-report.outputs.passed }}
          VUNIT_FAILED=${{ steps.test-report.outputs.failed }}
          # Note: These outputs now sum up both VUnit and SBY. 
          # We will just use badge logic based on step outcome for accuracy.

          if [ "${{ steps.sby_step.outcome }}" == "success" ]; then
             SBY_BADGE="passing-success"
             SBY_TEXT="passing"
          else
             SBY_BADGE="failing-critical"
             SBY_TEXT="failing"
          fi

          echo "# FPGA Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "[![Test Results](https://img.shields.io/badge/Verification_Table-Click_Here-blue?style=for-the-badge&logo=github)]($REPORT_URL) " >> $GITHUB_STEP_SUMMARY
          echo "[![SBY Logs](https://img.shields.io/badge/Formal_Logs-$SBY_TEXT-$SBY_BADGE?style=for-the-badge&logo=formal-verification)]($JOB_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          echo "### Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "The Verification Results Table above now includes both Simulation (VUnit) and Formal Verification (SBY) results." >> $GITHUB_STEP_SUMMARY
          
          echo "### Formal Verification Details" >> $GITHUB_STEP_SUMMARY
          if [ "$SBY_TEXT" == "passing" ]; then
            echo "The design logic has been formally verified against PSL assertions." >> $GITHUB_STEP_SUMMARY
            echo "Configuration: 1000Hz clock, 10ms delay target, 200 depth." >> $GITHUB_STEP_SUMMARY
          else
            echo "Formal verification FAILED. Please check the logs." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
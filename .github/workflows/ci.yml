name: FPGA Timer Verification CI

on:
  push:
    branches: [ main, task* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      checks: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup FPGA Tools
        uses: YosysHQ/setup-oss-cad-suite@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python Libs
        run: pip3 install vunit_hdl --break-system-packages

      # Run VUnit simulation
      - name: Run VUnit Tests
        run: python3 run.py -v --xunit-xml test_results.xml

      # Run Formal Verification
      - name: Run Formal Verification
        id: sby_step
        run: sby -f timer.sby
        continue-on-error: true

      # Generate SBY XML
      - name: Generate SBY XML Report
        if: always()
        run: |
          if [ "${{ steps.sby_step.outcome }}" == "success" ]; then
            FAILURES="0"
            FAILURE_BLOCK=""
          else
            FAILURES="1"
            FAILURE_BLOCK="<failure message=\"Formal verification failed.\">Check logs</failure>"
          fi
          
          cat <<EOF > sby_results.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <testsuite name="Formal Verification" tests="1" failures="$FAILURES" skipped="0" time="1.0">
            <testcase classname="SBY.Formal" name="Mathematical_Proof_Depth_200" time="1.0">
              $FAILURE_BLOCK
            </testcase>
          </testsuite>
          EOF

      # --- SEPARATE REPORTING STEPS ---

      # Publish ONLY VUnit Results
      - name: Publish VUnit Report
        id: vunit-report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: VUnit Simulation Results
          path: 'test_results.xml'
          reporter: java-junit

      # Publish ONLY SBY Results
      - name: Publish SBY Report
        id: sby-report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Formal Verification Results
          path: 'sby_results.xml'
          reporter: java-junit

      # Fail if SBY failed
      - name: Check SBY Status
        if: steps.sby_step.outcome == 'failure'
        run: exit 1

      # Generate Summary with Tables and Links
      - name: Create Full Test Summary
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch URL for VUnit Table
          VUNIT_URL=$(gh api /repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs --jq '.check_runs[] | select(.name=="VUnit Simulation Results") | .html_url' | head -n 1)
          
          # Fetch URL for Formal Table
          FORMAL_URL=$(gh api /repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs --jq '.check_runs[] | select(.name=="Formal Verification Results") | .html_url' | head -n 1)
          
          # Fallback to job url if missing
          JOB_URL=$(gh run view ${{ github.run_id }} --json jobs --jq '.jobs[] | select(.name=="test") | .url')
          if [ -z "$VUNIT_URL" ]; then VUNIT_URL="$JOB_URL"; fi
          if [ -z "$FORMAL_URL" ]; then FORMAL_URL="$JOB_URL"; fi

          # Badge Logic
          if [ "${{ steps.vunit-report.outputs.failed }}" -eq "0" ] && [ "${{ steps.vunit-report.outputs.passed }}" -gt "0" ]; then
            V_BADGE="passing-success"
            V_STATUS="PASS"
          else
            V_BADGE="failing-critical"
            V_STATUS="FAIL"
          fi

          if [ "${{ steps.sby_step.outcome }}" == "success" ]; then
             S_BADGE="passing-success"
             S_STATUS="PASS"
          else
             S_BADGE="failing-critical"
             S_STATUS="FAIL"
          fi

          echo "# FPGA Verification Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Interactive Buttons
          echo "[![VUnit](https://img.shields.io/badge/VUnit_Simulation-$V_BADGE?style=for-the-badge&logo=python)]($VUNIT_URL) " >> $GITHUB_STEP_SUMMARY
          echo "[![SBY](https://img.shields.io/badge/Formal_Verification-$S_BADGE?style=for-the-badge&logo=formal-verification)]($FORMAL_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          # VUnit Table Generation
          echo "### VUnit Simulation Results" >> $GITHUB_STEP_SUMMARY
          echo "| Test Scenario | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
          
          # Extract test names from XML and print row
          grep "testcase" test_results.xml | while read -r line ; do
            NAME=$(echo $line | sed -n 's/.*name="\([^"]*\)".*/\1/p')
            echo "| $NAME | $V_STATUS |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          # Formal Table Generation
          echo "### Formal Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "| Proof Target | Depth | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :---: |" >> $GITHUB_STEP_SUMMARY
          echo "| Mathematical_Proof_Depth_200 | 200 Steps | $S_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          # Explanations
          echo "### Test Scope Explanation" >> $GITHUB_STEP_SUMMARY
          echo "| Verification Type | Test Count | Description |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **VUnit Simulation** | **4 Tests** | Runs 4 specific scenarios covering Low/High Frequencies. Checks cycle accuracy. |" >> $GITHUB_STEP_SUMMARY
          echo "| **Formal Verification** | **1 Proof** | Mathematically proves the design logic covers ALL possible states within 200 depth steps. |" >> $GITHUB_STEP_SUMMARY